---
- name: Upgrade only security patches
  hosts: all
  gather_facts: True
  tasks:
   - name: Display user 
     debug:
      msg: "Runnig user {{ ansible_user }}"

   - name: Create directory for backup
     file:
      path: /etc/yum.repo.d/backup{{ ansible_date_time.date }}
      state: directory
      mode: '0755'

   - name: Move all repo to backup
     shell: mv /etc/yum.repo.d/*.repo /etc/yum.repo.d/backup{{ ansible_date_time.date }}

   - name: Write repo to the hosts
     blockinfile:
      path: /etc/yum.repo.d/local.repo
      create: yes
      block: |
       [RHEL_SECURITY]
       name=rhel-security_patch
       baseurl=http://<Repo server IP>
       enabled=1
      mode: '0644'
      owner: root
      group: root

   - name: Security Patches Only
     yum:
      name: "*"
      security: yes
      update_only: yes
      state: latest
     register: yumout

   - name: Validating the packages
     debug:
      msg: "{{ yumout.stdout }}"

